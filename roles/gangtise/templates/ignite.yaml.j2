

---
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: ClusterRole
metadata:
  name: ignite
  namespace: {{ ignite_namespace }}
rules:
  - apiGroups:
      - ""
    resources: # Here are resources you can access
      - pods
      - endpoints
    verbs: # That is what you can do with them
      - get
      - list
      - watch
---
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: ignite-config
  namespace: {{ ignite_namespace }}
data:
  quark-ignite-k8s.xml: |
    <?xml version="1.0" encoding="UTF-8"?>

    <beans xmlns="http://www.springframework.org/schema/beans"
           xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
           xsi:schemaLocation="http://www.springframework.org/schema/beans
                               http://www.springframework.org/schema/beans/spring-beans.xsd">

        <bean class="org.apache.ignite.configuration.IgniteConfiguration">
            <property name="igniteInstanceName" value="quark"/>
            <property name="peerClassLoadingEnabled" value="true"/>
            <property name="systemWorkerBlockedTimeout" value="3000000"/>
            <property name="gridLogger">
                <bean class="org.apache.ignite.logger.log4j2.Log4J2Logger">
                    <constructor-arg type="java.lang.String" value="/opt/ignite/apache-ignite/config/server-log4j2.xml"/>
                </bean>
            </property>
            <property name="workDirectory" value="/persistence"/>
            <property name="userAttributes">
                <map key-type="java.lang.String" value-type="java.lang.Boolean">
                    <entry key="DataNode" value="true"/>
                </map>
            </property>

            <property name="dataStorageConfiguration">
                <bean class="org.apache.ignite.configuration.DataStorageConfiguration">
                    <property name="pageSize" value="#{16 * 1024}"/>
                    <property name="walPath" value="/wal"/>
                    <property name="walArchivePath" value="/wal/archive"/>
                    <property name="concurrencyLevel" value="12"/>
                    <property name="defaultDataRegionConfiguration">
                        <bean class="org.apache.ignite.configuration.DataRegionConfiguration">
                            <property name="name" value="Default_Region"/>
                            <property name="metricsEnabled" value="true"/>
                            <property name="persistenceEnabled" value="true"/>

                            <!-- 5 GB initial size (RAM). -->
                            <property name="initialSize" value="#{2L * 1024 * 1024 * 1024}"/>

                            <!-- 20 GB maximum size (RAM). -->
                            <property name="maxSize" value="#{5L * 1024 * 1024 * 1024}"/>

                            <!-- Enabling RANDOM_LRU eviction for this region.  -->
                            <property name="pageEvictionMode" value="RANDOM_2_LRU"/>
                            <property name="evictionThreshold" value="0.8"/>
                        </bean>
                    </property>
                </bean>
            </property>

            <!-- Explicitly configure TCP discovery SPI to provide list of initial nodes. -->
            <property name="discoverySpi">
                <bean class="org.apache.ignite.spi.discovery.tcp.TcpDiscoverySpi">
                    <property name="ipFinder">
                        <!--
                        Enables Kubernetes IP finder and setting custom namespace name.
                        -->
                        <bean class="org.apache.ignite.spi.discovery.tcp.ipfinder.kubernetes.TcpDiscoveryKubernetesIpFinder">
                            <property name="namespace" value="ignite"/>
                        </bean>
                    </property>
                </bean>
            </property>
        </bean>
    </beans>

---
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1beta1
metadata:
  name: ignite
roleRef:
  kind: ClusterRole
  name: ignite
  apiGroup: rbac.authorization.k8s.io
subjects:
  - kind: ServiceAccount
    name: ignite
    namespace: {{ ignite_namespace }}
---
apiVersion: v1
kind: Service
metadata:
  # The name must be equal to TcpDiscoveryKubernetesIpFinder.serviceName
  name: ignite
  # The name must be equal to TcpDiscoveryKubernetesIpFinder.namespaceName
  namespace: {{ ignite_namespace }}
spec:
  type: NodePort
  ports:
    - name: rest
      port: 8080
      targetPort: 8080
    - name: sql
      port: 10800
      targetPort: 10800
    - name: thinclients
      port: 10900
      targetPort: 10900
  sessionAffinity: ClientIP
  selector:
    # Must be equal to the label set for Ignite pods.
    app: ignite
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: ignite
  namespace: {{ ignite_namespace }}
---
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  labels:
    app: ignite
    k8s.eip.work/layer: db
  name: ignite
  namespace: {{ ignite_namespace }}
spec:
  podManagementPolicy: OrderedReady
  replicas: 1
  revisionHistoryLimit: 10
  selector:
    matchLabels:
      app: ignite
      k8s.eip.work/layer: db
  serviceName: ignite
  template:
    metadata:
      labels:
        app: ignite
        k8s.eip.work/layer: db
    spec:
      imagePullSecrets:
      - name: {{ container_secret }}
      containers:
        - env:
            - name: OPTION_LIBS
              value: 'ignite-kubernetes,ignite-rest-http,ignite-log4j2,ignite-kafka'
            - name: CONFIG_URI
              value: /usr/config/quark-ignite-k8s.xml
            - name: IGNITE_QUIET
              value: 'false'
            - name: JVM_OPTS
              value: >-
                -Djava.net.preferIPv4Stack=true -server -Xmx4g
                -XX:+AlwaysPreTouch -XX:+UseG1GC -XX:+ScavengeBeforeFullGC
                -XX:+DisableExplicitGC -DIGNITE_MAX_INDEX_PAYLOAD_SIZE=2048
                -DIGNITE_BPLUS_TREE_LOCK_RETRIES=10000
                -DIGNITE_SKIP_CONFIGURATION_CONSISTENCY_CHECK=true
          image: {{ ignite_image }}
          imagePullPolicy: IfNotPresent
          name: ignite
          ports:
            - containerPort: 11211
              protocol: TCP
            - containerPort: 47100
              protocol: TCP
            - containerPort: 47500
              protocol: TCP
            - containerPort: 49112
              protocol: TCP
            - containerPort: 10800
              protocol: TCP
            - containerPort: 8080
              protocol: TCP
            - containerPort: 10900
              protocol: TCP
          resources:
            limits:
              cpu: '3'
              memory: 15Gi
          volumeMounts:
            - mountPath: /wal
              name: ignite-wal
            - mountPath: /persistence
              name: ignite-persistence
            - mountPath: /usr/config
              name: ignite-config-volume
      dnsPolicy: ClusterFirst
      restartPolicy: Always
      schedulerName: default-scheduler
      serviceAccount: ignite
      serviceAccountName: ignite
      terminationGracePeriodSeconds: 30
      volumes:
        - configMap:
            defaultMode: 420
            items:
              - key: quark-ignite-k8s.xml
                path: quark-ignite-k8s.xml
            name: ignite-config
          name: ignite-config-volume
  updateStrategy:
    rollingUpdate:
      partition: 0
    type: RollingUpdate
  volumeClaimTemplates:
    - metadata:
        name: ignite-persistence
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 50Gi
        storageClassName: {{ ignite_storageclass }}
        volumeMode: Filesystem
    - metadata:
        name: ignite-wal
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 50Gi
        storageClassName: {{ ignite_storageclass }}
        volumeMode: Filesystem
